<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Terraform-remote-locking by downneck</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Terraform-remote-locking</h1>
      <h2 class="project-tagline">use an s3 bucket to hold remote locks to prevent corruption of remote tfstate</h2>
      <a href="https://github.com/downneck/terraform-remote-locking" class="btn">View on GitHub</a>
      <a href="https://github.com/downneck/terraform-remote-locking/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/downneck/terraform-remote-locking/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="terraform-remote-locking" class="anchor" href="#terraform-remote-locking" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Terraform Remote Locking</h1>

<h3>
<a id="general-info" class="anchor" href="#general-info" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>General Info</h3>

<p>These scripts will help prevent corruption of a remote tfstate and allow for smoother team-wide interaction by using an s3 bucket to hold/check remote locks in addition to tfstate.</p>

<p>This software presumes that you're setting up your terraform config directory with a similar structure (represented in the Example Repo Directory Structure section below). Each subdirectory of the main config directory holds a separate terraform stack with its own remote tfstate. The links in each subdirectory (created using makelinks.bash) allow for sharing of variables across all stacks.</p>

<h3>
<a id="installation-and-configuration" class="anchor" href="#installation-and-configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation and Configuration</h3>

<ul>
<li>install and configure the AWS CLI as well as Terraform</li>
<li>create an S3 bucket to hold the state and lock files, ensure you (and the rest of your team) have write access to the bucket</li>
<li>set up your terraform config directory. we have provided a reference structure here and strongly recommend the use of git to track your infrastructure changes</li>
<li>set your TF_STATE_BUCKET to point at the S3 bucket (ex. TF_STATE_BUCKET="my-s3-bucket-name")</li>
<li>run the install_scripts.bash script, giving it your terraform config directory</li>
<li>run makelinks.bash from inside your terraform config directory</li>
</ul>

<h3>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h3>

<p>NOTE: to make a new stack, create the empty directory under your main terraform directory (ie. the one with makelinks.bash in it) and then run makelinks.bash. DO NOT COPY EXISTING DIRECTORIES as this will copy the tfstate and cause havoc.</p>

<p>Applying terraform changes</p>

<ul>
<li>cd into the target stack's directory</li>
<li>update default.tf with your changes</li>
<li>run ./plan.bash (do not run "terraform plan" directly)</li>
<li>run ./apply.bash (assuming plan.bash succeeds) (do not run "terraform apply" directly)</li>
</ul>

<p>if your plan fails for any reason or if you decide not to apply the plan, you can use clearlocks.bash to remove your user's lock from that stack. removing an entire stack with "terraform destroy" remains unchanged.</p>

<h3>
<a id="example-repo-directory-structure" class="anchor" href="#example-repo-directory-structure" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example Repo Directory Structure</h3>

<p>an example stack directory is also included as part of this repo</p>

<pre><code>├── apply.bash
├── clearlocks.bash
├── makelinks.bash
├── plan.bash
├── provider.tf
├── terraform.tfvars
├── variables.tf
├── service.us-east-1
│   ├── apply.bash -&gt; ../apply.bash
│   ├── clearlocks.bash -&gt; ../clearlocks.bash
│   ├── default.tf
│   ├── plan.bash -&gt; ../plan.bash
│   ├── provider.tf -&gt; ../provider.tf
│   ├── terraform.tfvars -&gt; ../terraform.tfvars
│   └── variables.tf -&gt; ../variables.tf
├── frontend.us-east-1
│   ├── apply.bash -&gt; ../apply.bash
│   ├── clearlocks.bash -&gt; ../clearlocks.bash
│   ├── default.tf
│   ├── plan.bash -&gt; ../plan.bash
│   ├── provider.tf -&gt; ../provider.tf
│   ├── terraform.tfvars -&gt; ../terraform.tfvars
│   └── variables.tf -&gt; ../variables.tf
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/downneck/terraform-remote-locking">Terraform-remote-locking</a> is maintained by <a href="https://github.com/downneck">downneck</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
